name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup SSH Key
      - name: Setup SSH Key
        run: |
          echo "${{ secrets.STAGING_KEY }}" | base64 --decode > private_key
          chmod 600 private_key
          eval "$(ssh-agent -s)"
          ssh-add private_key

      # Verify Secrets
      - name: Verify Secrets
        run: |
          echo "üîç Checking environment secrets..."
          if [ -z "${{ secrets.STAGING_USER }}" ] || [ -z "${{ secrets.STAGING_HOST }}" ]; then
            echo "‚ùå Missing one or more required secrets!"
            exit 1
          fi
          echo "‚úÖ Secrets loaded correctly!"

      # Test SSH Connection
      - name: Test SSH Connection
        run: |
          ssh -i private_key -o StrictHostKeyChecking=no \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "echo '‚úÖ SSH connection successful!'"

      # Deploy Application
      - name: Deploy Application
        run: |
          ssh -i private_key -o ServerAliveInterval=60 -o StrictHostKeyChecking=no \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          cd $APP_DIR || { echo "‚ùå Directory not found: $APP_DIR"; exit 1; }

          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

          echo "üîÑ Pulling latest changes..."
          git fetch --all --prune && git reset --hard origin/main

          echo "üîß Updating environment variables..."
          echo "${{ secrets.STAGING_ENV }}" | tr -d '\r' > .env
          echo "‚úÖ Environment updated."

          echo "üßπ Optional Docker cleanup..."
          docker container prune -f || true
          docker image prune -af || true
          docker builder prune -af || true
          docker volume prune -f || true

          echo "üöÄ Rebuilding & restarting containers..."
          docker compose down
          docker compose up --build -d

          echo "‚úÖ Deployment completed successfully!"
          EOF


      # Cleanup
      - name: Cleanup
        run: rm -f private_key




# name: Deploy to Digital Ocean

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Setup SSH Key
#         run: |
#           echo "${{ secrets.STAGING_KEY }}" | base64 --decode > private_key
#           chmod 600 private_key

#       - name: Test SSH Connection
#         run: |
#           ssh -i private_key -o StrictHostKeyChecking=no \
#             ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
#             "echo '‚úÖ SSH connection successful!' && whoami && hostname"

#       - name: Deploy Application
#         run: |
#           ssh -i private_key -o ServerAliveInterval=60 -o StrictHostKeyChecking=no \
#             ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
#           set -euo pipefail

#           APP_DIR="${{ secrets.APP_DIR }}"
#           echo "üìÅ APP_DIR=$APP_DIR"
#           cd "$APP_DIR" || { echo "‚ùå Directory not found: $APP_DIR"; exit 1; }

#           echo "üîÑ Pulling latest changes..."
#           git fetch --all --prune
#           git reset --hard origin/main
#           git clean -fd

#           echo "üîß Writing .env (safe)..."
#           cat > .env << 'ENVEOF'${{ secrets.STAGING_ENV }}
#           ENVEOF
#           tr -d '\r' < .env > .env.tmp && mv .env.tmp .env
#           chmod 600 .env

#           echo "üîé Sanity check:"
#           ls -la .env docker-compose.yml

#           echo "üöÄ Rebuilding & restarting containers..."
#           docker compose down --remove-orphans
#           docker compose up --build -d

#           echo "‚úÖ Running containers:"
#           docker ps
#           EOF

#       - name: Cleanup
#         run: rm -f private_key
